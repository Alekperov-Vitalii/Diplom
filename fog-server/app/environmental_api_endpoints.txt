# Environmental API endpoints - append this at the end of main.py before __main__ section

# ============================================================================
# ENVIRONMENTAL API ENDPOINTS
# ============================================================================

# Storage for pending environmental commands
pending_environmental_commands: Dict[str, Dict] = {}

@app.post("/api/v1/environmental/telemetry")
async def receive_environmental_telemetry(payload: EnvironmentalPayload):
    """
    –ü—Ä–∏—ë–º environmental telemetry –æ—Ç ESP32
    
    –î–µ–π—Å—Ç–≤–∏—è:
    1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ InfluxDB
    2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ environmental alerts
    3. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–µ—Å–ª–∏ —Ä–µ–∂–∏–º AUTO)  
    4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ trend analyzer
    5. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ cooling efficiency modifier
    """
    try:
        # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ InfluxDB
        influx_manager.write_environmental_telemetry(payload)
        
        # 2. Add to trend analyzer
        import time
        current_time = time.time()
        trend_analyzer.add_data_point(
            payload.sensors.humidity,
            payload.sensors.dust,
            current_time
        )
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º alerts
        new_alerts = environmental_control_algo.check_environmental_alerts(
            payload.sensors.humidity,
            payload.sensors.dust,
            payload.timestamp
        )
        for alert in new_alerts:
            influx_manager.write_environmental_alert(alert)
        
        # 4. –í—ã—á–∏—Å–ª—è–µ–º control commands (if auto mode)
        global pending_environmental_commands
        
        if system_mode["mode"] ==" "auto":
            control_commands = environmental_control_algo.calculate_control_commands(
                payload.sensors.humidity,
                payload.sensors.dust
            )
            pending_environmental_commands[payload.device_id] = control_commands
        
        print(f"‚úì Environmental telemetry received from {payload.device_id}")
        print(f"  Humidity: {payload.sensors.humidity:.1f}%, Dust: {payload.sensors.dust:.1f} Œºg/m¬≥")
        
        return {
            "status": "success",
            "message": "Environmental telemetry received",
            "alerts": len(new_alerts)
        }
    
    except Exception as e:
        print(f"‚úó Error processing environmental telemetry: {e}")
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/api/v1/environmental/control/{device_id}")
async def get_environmental_commands(device_id: str):
    """
    ESP32 –ø–æ–ª—É—á–∞–µ—Ç environmental control commands
    
    Returns:
        Dict with commands or 204 No Content
    """
    if device_id in pending_environmental_commands:
        commands = pending_environmental_commands.pop(device_id)
        return commands
    else:
        return None


@app.get("/api/v1/environmental/current")
async def get_current_environmental_state():
    """
    API –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: —Ç–µ–∫—É—â–µ–µ environmental —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    """
    try:
        # Query latest environmental data
        history = influx_manager.query_environmental_history(hours=1)
        
        # Extract latest values
        latest_humidity = None
        latest_dust = None
        
        for point in reversed(history):
            if point["field"] == "humidity" and latest_humidity is None:
                latest_humidity = point["value"]
            if point["field"] == "dust" and latest_dust is None:
                latest_dust = point["value"]
            if latest_humidity is not None and latest_dust is not None:
                break
        
        # Get current actuator states
        actuator_states = {
            "dehumidifier_active": environmental_control_algo.dehumidifier_active,
            "dehumidifier_power": environmental_control_algo.dehumidifier_power,
            "humidifier_active": environmental_control_algo.humidifier_active,
            "humidifier_power": environmental_control_algo.humidifier_power
        }
        
        return {
            "humidity": latest_humidity,
            "dust": latest_dust,
            "actuators": actuator_states,
            "alerts": environmental_control_algo.active_environmental_alerts,
            "timestamp": datetime.now(timezone.utc).isoformat()
        }
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/api/v1/environmental/history")
async def get_environmental_history(hours: int = 1):
    """
    API –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: environmental historical data
    """
    try:
        data = influx_manager.query_environmental_history(hours)
        return {"data": data}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/api/v1/environmental/trends")
async def get_environmental_trends():
    """
    API –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: computed environmental trends
    """
    try:
        # Calculate trends
        humidity_rate = trend_analyzer.calculate_hourly_humidity_change_rate()
        dust_rate = trend_analyzer.calculate_hourly_dust_accumulation_rate()
        
        # Infer hidden factors
        ventilation_level = trend_analyzer.infer_ventilation_level(humidity_rate)
        filtration_quality = trend_analyzer.infer_filtration_quality(dust_rate)
        
        # Get latest environmental values for cooling efficiency
        history = influx_manager.query_environmental_history(hours=1)
        latest_humidity = 50.0
        latest_dust = 25.0
        
        for point in reversed(history):
            if point["field"] == "humidity":
                latest_humidity = point["value"]
                break
        for point in reversed(history):
            if point["field"] == "dust":
                latest_dust = point["value"]
                break
        
        cooling_efficiency = environmental_control_algo.get_cooling_efficiency_modifier(
            latest_humidity,
            latest_dust
        )
        
        return {
            "trends": {
                "hourly_humidity_change_rate": {
                    "value": humidity_rate,
                    "interpretation": ventilation_level,
                    "formula": "avg(current RH - previous RH) over last hour"
                },
                "hourly_dust_accumulation_rate": {
                    "value": dust_rate,
                    "interpretation": filtration_quality,
                    "formula": "avg(current PM - previous PM) over last hour"
                },
                "cooling_efficiency_modifier": {
                    "value": cooling_efficiency,
                    "reduction_percent": (1.0 - cooling_efficiency) * 100,
                    "formula": "1 - (0.002 * |RH - 50|) - (0.001 * PM)"
                }
            },
            "timestamp": datetime.now(timezone.utc).isoformat()
        }
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.post("/api/v1/environmental/control")
async def set_environmental_control(command: EnvironmentalControlCommand):
    """
    Manual environmental control (user override)
    """
    try:
        # Store manual command
        device_id = "esp32_master_001"  # Default device
        
        commands = {
            "dehumidifier_active": command.dehumidifier_active,
            "dehumidifier_power": command.dehumidifier_power,
            "humidifier_active": command.humidifier_active,
            "humidifier_power": command.humidifier_power
        }
        
        # Add to pending commands
        global pending_environmental_commands
        pending_environmental_commands[device_id] = commands
        
        # Log user action
        log_user_action(
            action="environmental_control",
            details=commands
        )
        
        print(f"üéõÔ∏è Manual environmental control applied: {commands}")
        
        return {
            "status": "success",
            "message": "Environmental control command sent",
            "commands": commands
        }
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
